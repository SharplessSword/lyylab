<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>lyy 的实验室</title>
    <link rel="stylesheet" type="text/css" href={{ url_for('static', filename='base.css') }}/>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.1/dist/echarts.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
<div>
    {% for reaction in reaction_list %}
        <h2 style="text-align: center;color:black">{{ reaction.reactant_title }} 's</h2>
        <div style="overflow-x: scroll; ">
        <table style="border-collapse: collapse;">
            <thead>
            <tr class="header">
                <th style="background: #189AB4">T(K)</th>
                {% for name in reaction.column_name %}
                    <th>{{ name }}</th>
                    <th>分支比</th>
                {% endfor %}
                <th>Loss</th>
            </tr>
            </thead>
            {% for i in range(reaction.temperature|length) %}
                <tr>
                    <td>{{ reaction.temperature[i] }}</td>
                    {% for key in reaction.branch_data_dict %}
                        {% if reaction.branch_ratio_dict[key][i] >= 0.1  %}
                            <td class="important_reaction">{{ reaction.branch_data_dict[key][i] }}</td>
                            <td class="important_reaction">{{ reaction.branch_ratio_dict[key][i] }}</td>
                        {% else %}
                            <td>{{ reaction.branch_data_dict[key][i] }}</td>
                            <td>{{ reaction.branch_ratio_dict[key][i] }}</td>
                        {% endif %}
                    {% endfor %}
                    <td>{{ reaction.loss[i] }}</td>
                </tr>
            {% endfor %}
        </table>
        </div>
    {% endfor %}
    {% for reaction in reaction_list %}
        {% for important_branch in reaction.important_branch_list %}
             <div class="each-reaction-container" style="display: flex;justify-content: center;border-bottom: 1px solid #4169E1;">
             <div id="{{ reaction.reactant_title }} {{ important_branch }}" style="width: 800px;height:600px;"></div>
                <script type="text/javascript">{
                  // 基于准备好的dom，初始化echarts实例
                  var myChart = echarts.init(document.getElementById('{{ reaction.reactant_title }} {{ important_branch }}'))
                  // 指定图表的配置项和数据
                  var option = {
                    title: {
                      text: '{{ reaction.reactant_title }} {{ important_branch }}'
                    },
                    tooltip: {trigger:'axis'},
                    legend: {
                      data: ['比例']
                    },
                    toolbox: {
                    feature: {
                        saveAsImage: {}
                        }
                    },
                    xAxis: {
                      data: {{ reaction.temperature }}
                    },
                    yAxis: {
                        type: 'value'
                    },
                    series: [
                      {
                        name: '反应',
                        type: 'line',
                        connectNulls:true,
                        data: {{ reaction.branch_data_dict[important_branch] }},
                        smooth:true,
                        stack: 'x',
                      },
                      {
                        name: '拟合',
                        type: 'line',
                        connectNulls:true,
                        data: [0,0,0,0,0,0,0,0],
                        smooth:true,
                      }

                    ]
                  };
                  // 使用刚指定的配置项和数据显示图表。
                  myChart.setOption(option);
                }
                </script>
            <table id='{{ reaction.reactant_title }} {{ important_branch }} table' class="table" style="margin-left: 100px">
                <thead>
                <tr style="font-size: 18px; background: #189AB4">
                    <th>T(K)</th>
                    <th>原始数据</th>
                    <th>拟合数据</th>
                </tr>
                </thead>
            <tbody>
            {% for i in range(reaction.branch_data_dict[important_branch]|length) %}
            <tr  style="font-size: 22px">
                <td style="background: #7EC8E3">{{ reaction.temperature[i] }}</td>
                <td contenteditable="true" style="background: #7EC8E3">{{ reaction.branch_data_dict[important_branch][i] }}</td>
                <td contenteditable="true" style="background: #7EC8E3">0</td>
            </tr>
            {% endfor %}
            </tbody>
            </table>
            <div class="ane_and_button" style="flex-direction: column;display:flex;justify-content: flex-start;margin-left: 100px">
            <table class="ane" id="{{ reaction.reactant_title }} {{ important_branch }} table2">
                <thead>
                <tr style="font-size: 18px; background: #189AB4">
                    <th>A</th>
                    <th>n</th>
                    <th>E</th>
                </tr>
                </thead>
                <tr style="font-size: 18px; background: #7EC8E3">
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
            </table>
            <button id="btn_tx_1" onclick="btn_tx_r('{{ reaction.reactant_title }} {{ important_branch }}', {{ reaction.temperature }})" class="btn btn-primary" style="width:200px; height:75px;margin-top: 50px">绘制曲线</button>
            </div>
            </div>
        {% endfor %}
    {% endfor %}

</body>
<script>
    function btn_tx_r(id, temperature) {
                var myChart = echarts.init(document.getElementById(id));
                var table = document.getElementById(id+' table');
                var tr_list = table.getElementsByTagName('tr');
                var ane_table = document.getElementById(id+' table2')
                var ane_table_td = ane_table.getElementsByTagName('td')
                var array = [];
                for(var i=1; i<tr_list.length;i=i+1)
                {
                    console.log(tr_list[i])
                    td_list = tr_list[i].getElementsByTagName('td')
                    array.push(parseFloat(td_list[1].innerHTML))
                }
                var data = {
                    data: JSON.stringify({
                    'xdata': temperature,
                    'ydata': array
                    }),
                 }
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    url: "/update",//后端请求
                    data: data,
                    success: function (result) {

                    for(var i=1; i<tr_list.length;i=i+1)
                    {
                        td_list = tr_list[i].getElementsByTagName('td')
                        td_list[1].innerHTML = result['ydata'][i-1]
                        td_list[2].innerHTML = result['fit_ydata'][i-1]
                    }
                    ane_table_td[0].innerHTML=result['a']
                    ane_table_td[1].innerHTML=result['n']
                    ane_table_td[2].innerHTML=result['e']
                    var option = myChart.getOption()
                    option['series'][0]['data'] = result['ydata']
                    option['series'][1]['data'] = result['fit_ydata']

                    // 指定图表的配置项和数据
                    // 使用刚指定的配置项和数据显示图表。
                    myChart.setOption(option);

                    },
                    error: function (result) {
                    }
                    })

            }
    function get_upload_file(){
        var objFile = document.getElementById('outfile')
        var file = objFile.files[0]

    }
    function getFile(){
        document.getElementById('upload_file').click()

    }

</script>
</html>